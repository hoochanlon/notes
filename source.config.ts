import {
  defineConfig,
  defineDocs,
  frontmatterSchema,
  metaSchema,
} from 'fumadocs-mdx/config';
import rehypeKatex from 'rehype-katex';
import remarkMath from 'remark-math';
import { remarkImage } from 'fumadocs-core/mdx-plugins';
import { z } from 'zod';

// 扩展 frontmatter schema：可选 slug、lastUpdated、toc、footer、tags 和 editOnGitHub
const slugSchema = z.object({
  // slug 可以是字符串（单个路径段）或字符串数组（多个路径段）
  slug: z.union([z.string(), z.array(z.string())]).optional(),
  // 手动指定最近更新日期，ISO 字符串或可被 Date 解析的字符串
  lastUpdated: z.coerce.date().optional(),
  // 发布时间
  publishedAt: z.coerce.date().optional(),
  // 是否显示目录
  toc: z.boolean().optional(),
  // 是否显示页脚
  footer: z.boolean().optional(),
  // 是否显示 GitHub 编辑按钮
  editOnGitHub: z.boolean().optional(),
  // 标签：可以是字符串数组或单个字符串
  tags: z.union([z.array(z.string()), z.string()]).optional(),
  // 密码：用于加密文章内容，可以是明文或 base64 编码
  password: z.string().optional(),
  // 密码提示：显示在密码输入界面，用于提示读者密码
  passwordHint: z.string().optional(),
});
const customFrontmatterSchema = frontmatterSchema.merge(slugSchema);

// You can customise Zod schemas for frontmatter and `meta.json` here
// see https://fumadocs.dev/docs/mdx/collections
export const notes = defineDocs({
  dir: 'content/notes',
  docs: {
    schema: customFrontmatterSchema,
    postprocess: {
      includeProcessedMarkdown: true,
      extractLinkReferences: true,
    },
  },
  meta: {
    schema: metaSchema,
  },
});

export default defineConfig({
  mdxOptions: {
    remarkPlugins: [
      remarkMath,
      [
        remarkImage,
        {
          // 禁用远程图片尺寸获取，允许无限制使用 ![](url) 语法
          external: false,
          // 如果获取图片尺寸失败，忽略错误而不是抛出异常
          onError: 'ignore',
        },
      ],
    ],
    rehypePlugins: (v) => [rehypeKatex, ...v],
    rehypeCodeOptions: {
      themes: {
        light: 'github-light',
        dark: 'github-dark',
      },
      icon: {
        // 直接用字符串图标（最简单、无需额外依赖）
        extend: {
          mdx: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="#3b3b3b" d="M.79 7.12h22.42c.436 0 .79.355.79.792v8.176a.79.79 0 0 1-.79.79H.79a.79.79 0 0 1-.79-.79V7.912a.79.79 0 0 1 .79-.791zm2.507 7.605v-3.122l1.89 1.89L7.12 11.56v3.122h1.055v-5.67l-2.99 2.99L2.24 9.056v5.67h1.055v-.001Zm8.44-1.845l-1.474-1.473l-.746.746l2.747 2.747l2.745-2.747l-.746-.746l-1.473 1.473v-4h-1.054v4Zm10.041.987l-2.175-2.175l2.22-2.22l-.746-.746l-2.22 2.22l-2.22-2.22l-.747.746l2.22 2.22l-2.176 2.177l.746.746l2.177-2.177l2.176 2.175z"/></svg>`,
          css: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M22.5 0h-21A1.5 1.5 0 0 0 0 1.5v21A1.5 1.5 0 0 0 1.5 24h21a1.5 1.5 0 0 0 1.5-1.5v-21A1.5 1.5 0 0 0 22.5 0m-15 18.88a.63.63 0 0 1 0 1.25a4.63 4.63 0 0 1 0-9.25a.63.63 0 0 1 0 1.25a3.38 3.38 0 1 0 0 6.75m3.3-4.43l1.95 1a2.45 2.45 0 0 1 1.37 2.22a2.48 2.48 0 0 1-2.47 2.48H9.5a.63.63 0 0 1 0-1.25h2.15a1.23 1.23 0 0 0 .55-2.33l-1.95-1a2.48 2.48 0 0 1 1.1-4.69h2.15a.63.63 0 0 1 0 1.25h-2.15a1.22 1.22 0 0 0-.55 2.32m6 0l1.95 1a2.45 2.45 0 0 1 1.37 2.22a2.48 2.48 0 0 1-2.47 2.48H15.5a.63.63 0 0 1 0-1.25h2.15a1.23 1.23 0 0 0 .55-2.33l-1.95-1a2.48 2.48 0 0 1 1.1-4.69h2.15a.63.63 0 0 1 0 1.25h-2.15a1.22 1.22 0 0 0-.55 2.32"/></svg>`,
          json: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" stroke="#3b3b3b" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 16v-1m3 1v-1m3 1v-1M6.835 4q-.747.022-1.297.242a1.86 1.86 0 0 0-.857.66q-.285.438-.285 1.164V9.23q0 1.12-.594 1.802q-.593.66-1.802.88v.131q1.23.22 1.802.901q.594.66.594 1.78v3.231q0 .704.285 1.143q.286.461.835.66q.55.219 1.32.241M17.164 4q.747.022 1.297.242q.55.219.857.66q.285.438.285 1.164V9.23q0 1.12.594 1.802q.593.66 1.802.88v.131q-1.23.22-1.802.901q-.594.66-.594 1.78v3.231q0 .704-.285 1.143q-.286.461-.835.66q-.55.219-1.32.241"/></svg>`, 
          styl: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M8.45 16q-.35 0-.625-.213t-.35-.562L5.65 7.575q-.05-.275.013-.525t.262-.45l5.4-4.975Q11.6 1.35 12 1.35t.675.275l5.4 4.975q.2.2.263.45t.012.525l-1.825 7.65q-.075.35-.35.563T15.55 16zm.8-2h5.5l1.525-6.325L13 4.65V7.3q.35.25.55.625t.2.825q0 .725-.512 1.238T12 10.5t-1.237-.513t-.513-1.237q0-.45.2-.825T11 7.3V4.65L7.725 7.675zm-3.875 7q-.5 0-.812-.413t-.138-.912l.125-.3q.2-.625.725-1T6.45 18h11.1q.65 0 1.175.375t.725 1l.125.3q.175.5-.137.913t-.813.412z"/></svg>`,
          pug: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512"><path fill="currentColor" d="M426.01 122.518c26.77 13.197 87.919 79.957 85.943 84.362c-2.005 4.396-31.186 28.777-39.978 38.369c-19.094 43.82-36.314 75.198-42.498 40.255c-7.03 42.025-22.079 38.346-27.956 58.876c-8.576 42.239-33.25 43.68-44.453 51.565c-10.274 10.274-24.993 4.347-36.353 10.175c-28.855 10.767-97.02 12.67-124.272.395c-14.578-6.284-21.876 3.494-63.025-24.696c-21.922-21.798-15.725-31.713-23.313-46.36c-12.528-21.605-16.965-7.505-26.623-55.774c-2.925 38.97-23.955 18.12-43.337-34.664c0 0-38.121-33.794-40.097-38.14c-2.005-4.406 59.143-71.166 85.943-84.363c75.982-34.45 256.267-33.54 340.02 0M296.16 238.6c41.049 13.904 79.84 58.067 73.434 98.588c0 21.041-1.877 35.266-4.94 44.848c35.05-22.998 19.693-30.392 33.637-52.504c13.16-22.457 15.802-14.236 22.602-44.631c-4.07-30.426-8.002-84.343-12.862-100.445c-4.248-13.83-24.795-42.576-38.052-60.17c-64.646-24.953-192.646-16.953-225.487-.988c-13.237 17.485-34.674 47.22-39.02 61.445c-4.594 15.252-8.767 67.691-12.62 98.71c3.176 29.505 25.432 42.551 28.751 58.17c3.553 25.144 15.033 33.7 30.96 42.29c-3.557-9.78-5.631-24.597-5.631-47.318c-6.64-46.889 38.92-86.79 75.82-98.291c10.203-27.082 65.395-24.58 73.407.296m7.149 113.006c0-28.648-23.48-52.46-41.064-53.893l1.036-42.131c33.97-2.16 30.027-27.032-4.277-28.777c-26.36.228-44.863 24.494-4.417 28.727l-.031 42.033c-17.584 0-40.737 24.284-40.737 53.465c2.74-29.283 25.549-44.43 46.39-43.799c20.303.614 38.627 16.252 43.1 44.375M166.235 210.417c0-7.046-7.68-11.474-13.79-7.95c-6.112 3.522-6.112 12.378 0 15.9c6.11 3.524 13.79-.904 13.79-7.95m-35.998 46.043c-23.392-13.486-23.392-47.384 0-60.87c23.393-13.486 52.792 3.463 52.792 30.435s-29.4 43.92-52.792 30.435m220.212 0c-23.392-13.486-23.392-47.384 0-60.87c23.393-13.486 52.792 3.463 52.792 30.435s-29.4 43.92-52.792 30.435m17.624-46.043c0-7.046-7.68-11.474-13.79-7.95s-6.112 12.378 0 15.9s13.79-.904 13.79-7.95"/></svg>`,
          powershell: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M4.887 20h11.868c.893 0 1.664-.665 1.847-1.592l2.358-12c.212-1.081-.442-2.14-1.462-2.366A1.8 1.8 0 0 0 19.113 4H7.245c-.893 0-1.664.665-1.847 1.592l-2.358 12c-.212 1.081.442 2.14 1.462 2.366q.191.042.385.042"/><path d="m9 8l4 4l-6 4m5 0h3"/></g></svg>`,
          batch: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 32 32"><path fill="currentColor" d="M32 26v-2h-2.101a5 5 0 0 0-.732-1.753l1.49-1.49l-1.414-1.414l-1.49 1.49A5 5 0 0 0 26 20.101V18h-2v2.101a5 5 0 0 0-1.753.732l-1.49-1.49l-1.414 1.414l1.49 1.49A5 5 0 0 0 20.101 24H18v2h2.101c.13.637.384 1.229.732 1.753l-1.49 1.49l1.414 1.414l1.49-1.49a5 5 0 0 0 1.753.732V32h2v-2.101a5 5 0 0 0 1.753-.732l1.49 1.49l1.414-1.414l-1.49-1.49A5 5 0 0 0 29.899 26zm-7 2c-1.654 0-3-1.346-3-3s1.346-3 3-3s3 1.346 3 3s-1.346 3-3 3m-5-11h-8a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2m-8-2h8V4h-8z"/><path fill="currentColor" d="M17 21H8a2 2 0 0 1-2-2V7h2v12h9z"/><path fill="currentColor" d="M13 25H4c-1.103 0-2-.897-2-2V11h2v12h9z"/></svg>`,
          conf: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><g fill="none"><path d="M21 18a3 3 0 1 1-6 0a3 3 0 0 1 6 0"/><path stroke="currentColor" stroke-linecap="square" stroke-width="2" d="M20 10V7l-5-5H4v20h6m4-20v6h6m-2 7v-1.25M18 15a3 3 0 0 0 0 6m0-6a3 3 0 1 1 0 6m0 0v1.25m-2.598-5.75l-1.083-.625m6.279 3.625l1.083.625M20.598 16.5l1.083-.625M15.4 19.5l-1.082.625"/></g></svg>`,
          toml: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 16 16"><path fill="currentColor" d="M0 .774C0 .347.347 0 .774 0h3.613a.774.774 0 0 1 0 1.548H1.548v12.904h2.84a.774.774 0 1 1 0 1.548H.773A.774.774 0 0 1 0 15.226zm10.839 0c0-.427.346-.774.774-.774h3.613c.427 0 .774.347.774.774v14.452a.774.774 0 0 1-.774.774h-3.613a.774.774 0 1 1 0-1.548h2.839V1.548h-2.84a.774.774 0 0 1-.773-.774m-6.71 4.13c0-.428.347-.775.774-.775h6.194a.774.774 0 0 1 0 1.548H8.774v7.484a.774.774 0 1 1-1.548 0V5.677H4.903a.774.774 0 0 1-.774-.774"/></svg>`,
          tex: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 32 32"><path d="M11.333 13.122c-.128-1.562-.241-2.756-2.287-2.756H7.91v8.4h2.145v.611l-3.083-.029l-3.082.029v-.611h2.144v-8.4h-1.15c-2.046 0-2.159 1.208-2.287 2.756H2l.284-3.367h9.362l.284 3.367h-.6Z"/><path d="M19.289 22.53H10.41v-.61h1.506v-8.453H10.41v-.611h8.637l.412 3.367h-.6c-.213-1.833-.682-2.756-2.855-2.756h-2.213V17.2h.838c1.364 0 1.505-.6 1.505-1.662h.6v3.935h-.6c0-1.08-.142-1.662-1.505-1.662h-.838v4.106h2.216c2.472 0 3-1.108 3.3-3.225h.6Z"/><path d="M27.727 19.186c-.54 0-1.96 0-2.415.029V18.6h1.179l-2.557-3.552l-2.529 3.381a4.1 4.1 0 0 0 1.295.171v.611c-.355-.029-1.576-.029-2.017-.029c-.4 0-1.548 0-1.875.029V18.6h.383a8 8 0 0 0 .824-.043c.5-.043.54-.085.667-.256l2.854-3.801l-3.153-4.418H19V9.47c.384.028 1.79.028 2.273.028c.582 0 1.918 0 2.429-.028v.611h-1.174l2.117 2.955l2.074-2.784a4.1 4.1 0 0 0-1.293-.17V9.47c.356.028 1.591.028 2.032.028c.4 0 1.534 0 1.861-.028v.611h-.369a5 5 0 0 0-.838.043c-.469.043-.526.071-.667.256l-2.4 3.21l3.591 5.01H30v.611c-.355-.025-1.818-.025-2.273-.025"/></svg>`,
          astro: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="#3b3b3b" d="M9.24 19.035c-.901-.826-1.164-2.561-.789-3.819c.65.793 1.552 1.044 2.486 1.186c1.44.218 2.856.137 4.195-.524c.153-.076.295-.177.462-.278c.126.365.159.734.115 1.11c-.107.915-.56 1.622-1.283 2.158c-.289.215-.594.406-.892.608c-.916.622-1.164 1.35-.82 2.41l.034.114a2.4 2.4 0 0 1-1.07-.918a2.6 2.6 0 0 1-.412-1.401c-.003-.248-.003-.497-.036-.74c-.081-.595-.36-.86-.883-.876a1.034 1.034 0 0 0-1.075.843q-.013.058-.033.126M4.1 15.007s2.666-1.303 5.34-1.303l2.016-6.26c.075-.304.296-.51.544-.51c.25 0 .47.206.545.51l2.016 6.26c3.167 0 5.34 1.303 5.34 1.303L15.363 2.602c-.13-.366-.35-.602-.645-.602H9.283c-.296 0-.506.236-.645.602c-.01.024-4.538 12.405-4.538 12.405"/></svg>`,
          scss: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 16 16"><path fill="#3b3b3b" fill-rule="evenodd" d="M14 4.5V11h-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v9H2V2a2 2 0 0 1 2-2h5.5zM1.356 15.29a1.2 1.2 0 0 1-.111-.449h.765a.58.58 0 0 0 .255.384q.105.073.249.114q.143.041.319.041q.246 0 .413-.07a.56.56 0 0 0 .255-.193a.5.5 0 0 0 .085-.29a.39.39 0 0 0-.153-.326q-.151-.12-.462-.193l-.619-.143a1.7 1.7 0 0 1-.539-.214a1 1 0 0 1-.351-.367a1.1 1.1 0 0 1-.123-.524q0-.366.19-.639q.19-.272.528-.422q.336-.15.776-.149q.457 0 .78.152q.324.153.5.41q.18.255.2.566h-.75a.56.56 0 0 0-.12-.258a.6.6 0 0 0-.247-.181a.9.9 0 0 0-.369-.068q-.325 0-.513.152a.47.47 0 0 0-.184.384q0 .18.143.3a1 1 0 0 0 .405.175l.62.143q.326.075.566.211t.375.358t.135.56q0 .37-.188.656a1.2 1.2 0 0 1-.539.439q-.351.158-.858.158q-.381 0-.665-.09a1.4 1.4 0 0 1-.478-.252a1.1 1.1 0 0 1-.29-.375m4.274-2.23a1.7 1.7 0 0 0-.103.633v.495q0 .369.103.627a.83.83 0 0 0 .298.392a.85.85 0 0 0 .478.132a.9.9 0 0 0 .401-.088a.7.7 0 0 0 .273-.249a.8.8 0 0 0 .117-.363h.765v.076a1.27 1.27 0 0 1-.226.674a1.4 1.4 0 0 1-.55.454a1.8 1.8 0 0 1-.786.164q-.54 0-.914-.217a1.4 1.4 0 0 1-.571-.626q-.195-.408-.194-.976v-.498q0-.569.197-.979a1.44 1.44 0 0 1 .57-.633q.38-.222.912-.222q.328 0 .607.097q.28.093.489.272a1.32 1.32 0 0 1 .466.964v.073h-.765a.85.85 0 0 0-.12-.38a.7.7 0 0 0-.273-.261a.8.8 0 0 0-.398-.097a.8.8 0 0 0-.475.138a.87.87 0 0 0-.301.398m2.609 1.781a1.13 1.13 0 0 0 .401.823q.193.162.478.252q.284.091.665.091q.507 0 .858-.158q.354-.158.54-.44a1.17 1.17 0 0 0 .187-.656q0-.336-.135-.56a1 1 0 0 0-.375-.357a2 2 0 0 0-.566-.21l-.62-.144a1 1 0 0 1-.405-.176a.37.37 0 0 1-.143-.299q0-.234.184-.384q.188-.152.513-.152q.213 0 .369.068a.6.6 0 0 1 .246.181a.56.56 0 0 1 .12.258h.75a1.1 1.1 0 0 0-.2-.566a1.2 1.2 0 0 0-.5-.41a1.8 1.8 0 0 0-.78-.152q-.438 0-.776.15q-.336.149-.527.421q-.19.273-.19.639q0 .302.123.524t.351.367q.228.143.54.213l.617.144q.311.073.463.193a.39.39 0 0 1 .153.326a.5.5 0 0 1-.085.29a.56.56 0 0 1-.255.193a1.1 1.1 0 0 1-.413.07q-.177 0-.32-.04a.8.8 0 0 1-.249-.115a.58.58 0 0 1-.255-.384zm3.502.449a1.2 1.2 0 0 1-.11-.449h.764a.58.58 0 0 0 .255.384q.105.073.249.114q.143.041.319.041q.246 0 .413-.07a.56.56 0 0 0 .255-.193a.5.5 0 0 0 .085-.29a.39.39 0 0 0-.152-.326q-.153-.12-.463-.193l-.618-.143a1.7 1.7 0 0 1-.54-.214a1 1 0 0 1-.351-.367a1.1 1.1 0 0 1-.123-.524q0-.366.19-.639q.19-.272.528-.422q.336-.15.776-.149q.458 0 .78.152q.324.153.5.41q.18.255.2.566h-.75a.56.56 0 0 0-.12-.258a.6.6 0 0 0-.247-.181a.9.9 0 0 0-.369-.068q-.325 0-.512.152a.47.47 0 0 0-.185.384q0 .18.143.3a1 1 0 0 0 .405.175l.62.143q.326.075.566.211t.375.358t.135.56q0 .37-.187.656a1.2 1.2 0 0 1-.54.439q-.351.158-.858.158q-.381 0-.665-.09a1.4 1.4 0 0 1-.478-.252a1.1 1.1 0 0 1-.29-.375"/></svg>`,

        }
      },
    },
  },
});
